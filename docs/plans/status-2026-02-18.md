# Moongate v2 - Current Status (2026-02-18)

## Summary
- Core server loop and TCP listener are running.
- Packet system is attribute-driven with source generation for packet table and packet definitions.
- Network-to-loop crossing is handled by a dedicated in-process message bus.
- Domain events are available via a dedicated event bus (`PlayerConnectedEvent`, `PlayerDisconnectedEvent`).
- Session model is split between transport (`GameNetworkSession`) and gameplay/protocol (`GameSession`).
- Login/reconnect handshake now handles the 4-byte seed path cleanly (no length-based buffer hack).
- Docker image build is available via `scripts/build_image.sh` and supports mapped `/app` and `/uo` volumes.
- Build and tests are green locally.

## Implemented Architecture (Current)

### Networking and Packet Flow
- `NetworkService` accepts client connections, buffers incoming bytes per session, frames packets, resolves packet length (fixed/variable), parses via `PacketRegistry`, and publishes to `IMessageBusService`.
- Initial network handshake is stateful:
  - `AwaitingSeed` accepts either `0xEF` login seed packet or raw 4-byte reconnect seed.
  - reconnect seed is consumed before normal packet parsing.
- `GameLoopService` drains `IMessageBusService` every tick and dispatches packets to registered listeners.
- Outbound packets are queued through `IOutgoingPacketQueue` and sent during loop processing.

### Packet Registry and Source Generator
- Packets use `[PacketHandler(opcode, sizing, Length = ..., Description = ...)]`.
- `PacketTable.Register(...)` is generated through the packets generator project.
- `PacketDefinition` constants are generated from packet attributes (no manual opcode constant drift).
- `PacketDescriptor` carries description metadata and packet type info.

### Session Model
- `GameNetworkSession`: transport-level state (client binding, pending bytes, protocol state, reconnect seed).
- `GameSession`: gameplay/protocol context (includes `ClientVersion` and references `GameNetworkSession`).
- Listeners receive `GameSession`.

### Eventing
- `IMessageBusService`: thread-safe packet bus for network thread -> game loop crossing.
- `IGameEventBusService`: domain event bus for in-loop/server events.
- `GameEventScriptBridgeService` bridges domain events to Lua function naming convention (`on_<event_name>`).

### Logging
- Optional packet hex dump logging controlled by `LogPacketData`.
- Packet dumps are routed to a dedicated sink/file.
- HTTP host logs are emitted to dedicated `moongate_http-*.log` files in the shared logs directory.

### Scripting
- Lua runtime (`LuaScriptEngineService`) supports callbacks/modules/globals and event bridge calls.
- `log` scripting module interop is fixed so `log.info(...)` remains callable even with global helper registration.
- Example init callback:

```lua
function on_player_connected(p)
	log.info("Anvedi che s'e connesson un client")
end
```

## Projects and Shared Metadata
- Shared metadata/version is aligned across projects.
- Current baseline version: `0.2.0`.

## Verification Snapshot
- `dotnet build src/Moongate.Server/Moongate.Server.csproj -v minimal`: success (warnings only)
- `dotnet test -v minimal`: success
- `./scripts/build_image.sh -t moongate-server:test`: success

## Open Items (Near-Term)
- Reduce AOT/trim warnings in scripting and HTTP path (`MapGet`, `dynamic`, `DispatchProxy`).
- Expand login/game flow packet handlers beyond current handshake/login set.
- Keep protocol notes in `docs/protocol/` synchronized with implemented packet coverage.
