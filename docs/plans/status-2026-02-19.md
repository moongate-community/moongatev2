# Moongate v2 - Current Status (2026-02-19)

## Summary
- Core server/game loop/network flow is stable with packet parsing and dispatch in place.
- Persistence is active with snapshot+journal and serial-based entity linking.
- Timer wheel now publishes runtime metrics through the shared metrics service.
- Login character list packet now supports direct mapping from `UOMobileEntity` collections.
- Build and targeted tests are green locally.

## Highlights Since 2026-02-18

### Persistence Model Evolution
- `UOMobileEntity` now stores item links by ID:
  - `BackpackId`
  - `EquippedItemIds` (`ItemLayerType -> Serial`)
- `UOItemEntity` now stores ownership/link metadata:
  - `ParentContainerId`
  - `ContainerPosition`
  - `EquippedMobileId`
  - `EquippedLayer`
- `AddItem(...)` automatically sets container parent/position.
- `AddEquippedItem(...)` on `UOMobileEntity` updates both slot mapping and equipped item ownership metadata.
- Snapshot mapper and persistence snapshots were extended to persist these references.

### Timer Diagnostics and Metrics
- Added `TimerMetricsSnapshot` and `ITimerMetricsSource`.
- `TimerWheelService` now reports:
  - active timers
  - total registered timers
  - total executed callbacks
  - callback error count
  - average callback duration (ms)
- Added `TimerMetricsProvider`, exposed under `timer.*` metric keys.

### Packet/API Ergonomics
- `CharactersStartingLocationsPacket.FillCharacters(...)` now has an overload that accepts `IReadOnlyList<UOMobileEntity>`.
- Mapping from mobiles to `CharacterEntry` happens inside the packet class.
- `LoginHandler` now uses the mobile overload directly.

## Verification Snapshot
- `dotnet test --filter TimerWheelServiceTests|MetricsCollectionServiceTests`: passed
- `dotnet test --filter UOMobileEntityTests|UOItemEntityTests|SaveSnapshotAsync_ShouldPersistAllEntities`: passed
- `dotnet test --filter CharactersStartingLocationsPacketTests|LoginHandlerTests`: passed

## Open Items (Near-Term)
- Wire full character equipment creation flow to the new `AddEquippedItem(...)` API end-to-end.
- Add removal helpers (`RemoveEquippedItem`) and consistency checks for inverse links.
- Continue reducing analyzer warnings in `Moongate.UO.Data` and console UI (`CA1859`).
