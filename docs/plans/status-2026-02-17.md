# Moongate v2 - Current Status (2026-02-17)

## Summary
- Core server loop and TCP listener are running.
- Packet system is now attribute-driven with source generation and a broad incoming packet map.
- Network-to-loop crossing is handled by a dedicated in-process message bus.
- Domain events are available via a dedicated event bus (`PlayerConnectedEvent`, `PlayerDisconnectedEvent`).
- Session model has been split between transport (`GameNetworkSession`) and gameplay/protocol (`GameSession`).
- Build and tests are green locally.

## Implemented Architecture (Current)

### Networking and Packet Flow
- `NetworkService` accepts client connections, buffers incoming bytes per session, frames packets, resolves packet length (fixed/variable), parses via `PacketRegistry`, and publishes to `IMessageBusService`.
- `GameLoopService` drains `IMessageBusService` every tick and dispatches packets to registered listeners.
- Outbound packets are queued through `IOutgoingPacketQueue` and sent during loop processing.

### Packet Registry and Source Generator
- Packets use `[PacketHandler(opcode, sizing, Length = ..., Description = ...)]`.
- `PacketTable.Register(...)` is generated/extended through the packets generator project.
- `PacketDescriptor` now carries description metadata and type info.
- A large set of incoming packets has been mapped (domain-grouped under `Packets/Incoming/...`).

### Session Model
- `GameNetworkSession`: transport-level state (socket/client binding, pending bytes, connection flags/state).
- `GameSession`: gameplay/protocol context (currently includes `ClientVersion` and references `GameNetworkSession`).
- Listeners now receive `GameSession` (not raw network session).

### Eventing
- `IMessageBusService`: thread-safe packet bus for network thread -> game loop crossing.
- `IGameEventBusService`: domain event bus for in-loop/server events.
- Initial events emitted: `PlayerConnectedEvent`, `PlayerDisconnectedEvent`.

### Logging
- Optional inbound packet hex dump logging controlled by `LogPacketData`.
- Packet dumps are routed to a dedicated log sink/file.

## Projects and Shared Metadata
- Global metadata/version configured in `Directory.Build.props`:
  - Version: `0.1.0`
  - Authors: `tom@orivega.io`

## Verification Snapshot
- `dotnet build -v minimal`: success (warnings only)
- `dotnet test tests/Moongate.Tests/Moongate.Tests.csproj -v minimal`: success

## Open Items (Near-Term)
- Add/update top-level `README.md` with run instructions.
- Add AOT publish gate in CI workflow (`ci.yml`) or dedicated verification job.
- Continue implementing protocol/login handlers on top of current packet and session foundations.
