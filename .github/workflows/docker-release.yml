name: Docker Release

on:
  push:
    tags:
      - "v*"
      - "*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.6.0 or 0.6.0)'
        required: false
        default: ''

permissions:
  contents: read

env:
  DOCKER_IMAGE: ${{ vars.DOCKERHUB_REPOSITORY || format('{0}/moongatev2', secrets.DOCKERHUB_USERNAME) }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      repository: ${{ steps.prep.outputs.repository }}
      version: ${{ steps.prep.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare image tags
        id: prep
        shell: bash
        run: |
          set -euo pipefail

          # Get repository from variable, secret, or default
          REPO="${{ vars.DOCKERHUB_REPOSITORY }}"
          
          if [[ -z "$REPO" ]]; then
            USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
            if [[ -n "$USERNAME" ]]; then
              REPO="${USERNAME}/moongatev2"
              echo "✓ Using repository from DOCKERHUB_USERNAME secret: ${REPO}"
            else
              # Fallback to moongate-community default
              REPO="moongate-community/moongatev2"
              echo "✓ Using default repository: ${REPO}"
            fi
          else
            echo "✓ Using repository from DOCKERHUB_REPOSITORY variable: ${REPO}"
          fi

          # Get version from tag or workflow input
          VERSION=""
          if [[ -n "${{ github.ref_name }}" && "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.sha }}"
          fi

          echo "✓ Using version: ${VERSION}"

          {
            echo "repository=${REPO}"
            echo "version=${VERSION}"
          } >> "$GITHUB_OUTPUT"

  build-amd64:
    needs: prepare
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show build info
        run: |
          echo "Repository: ${{ needs.prepare.outputs.repository }}"
          echo "Version: ${{ needs.prepare.outputs.version }}"
          echo "SHA: ${{ github.sha }}"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push amd64
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ needs.prepare.outputs.repository }}:amd64-${{ needs.prepare.outputs.version }}
          cache-from: type=gha,scope=amd64
          cache-to: type=gha,mode=max,scope=amd64

  build-arm64:
    needs: prepare
    runs-on: ubuntu-24.04-arm
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push arm64
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64
          push: true
          tags: ${{ needs.prepare.outputs.repository }}:arm64-${{ needs.prepare.outputs.version }}
          cache-from: type=gha,scope=arm64
          cache-to: type=gha,mode=max,scope=arm64

  merge:
    needs: [prepare, build-amd64, build-arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create multi-arch manifest
        shell: bash
        env:
          REPO: ${{ needs.prepare.outputs.repository }}
          VERSION: ${{ needs.prepare.outputs.version }}
          AMD64_DIGEST: ${{ needs.build-amd64.outputs.digest }}
          ARM64_DIGEST: ${{ needs.build-arm64.outputs.digest }}
        run: |
          set -euo pipefail

          echo "Creating manifest for ${REPO}:${VERSION}"

          # Create version tag
          docker buildx imagetools create \
            --tag "${REPO}:${VERSION}" \
            "${REPO}@${AMD64_DIGEST}" \
            "${REPO}@${ARM64_DIGEST}"

          # Create latest tag if this is a version tag (not SHA)
          if [[ "${VERSION}" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            docker buildx imagetools create \
              --tag "${REPO}:latest" \
              "${REPO}@${AMD64_DIGEST}" \
              "${REPO}@${ARM64_DIGEST}"
          fi
