name: Docker Release

on:
  push:
    tags:
      - "v*"
      - "*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.6.0 or 0.6.0)'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  build-amd64:
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.config.outputs.version }}
      repository: ${{ steps.config.outputs.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine repository and version
        id: config
        shell: bash
        run: |
          # Get repository from GitHub Variable or use default
          REPO="${{ vars.DOCKERHUB_REPOSITORY }}"
          if [[ -z "$REPO" ]]; then
            REPO="tgiachi/moongate"
          fi
          echo "repository=${REPO}" >> "$GITHUB_OUTPUT"
          echo "Using repository: ${REPO}"
          
          # Get version from tag or workflow input
          VERSION=""
          if [[ -n "${{ github.ref_name }}" && "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.sha }}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building version: ${VERSION}"

      - name: Show configuration
        run: |
          echo "Repository: ${{ steps.config.outputs.repository }}"
          echo "Version: ${{ steps.config.outputs.version }}"
          echo "Full tag: ${{ steps.config.outputs.repository }}:amd64-${{ steps.config.outputs.version }}"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push amd64
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.config.outputs.repository }}:amd64-${{ steps.config.outputs.version }}
          cache-from: type=gha,scope=amd64
          cache-to: type=gha,mode=max,scope=amd64

  build-arm64:
    runs-on: ubuntu-24.04-arm
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.config.outputs.version }}
      repository: ${{ steps.config.outputs.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine repository and version
        id: config
        shell: bash
        run: |
          # Get repository from GitHub Variable or use default
          REPO="${{ vars.DOCKERHUB_REPOSITORY }}"
          if [[ -z "$REPO" ]]; then
            REPO="tgiachi/moongate"
          fi
          echo "repository=${REPO}" >> "$GITHUB_OUTPUT"
          echo "Using repository: ${REPO}"
          
          # Get version from tag or workflow input
          VERSION=""
          if [[ -n "${{ github.ref_name }}" && "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.sha }}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building version: ${VERSION}"

      - name: Show configuration
        run: |
          echo "Repository: ${{ steps.config.outputs.repository }}"
          echo "Version: ${{ steps.config.outputs.version }}"
          echo "Full tag: ${{ steps.config.outputs.repository }}:arm64-${{ steps.config.outputs.version }}"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push arm64
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64
          push: true
          tags: ${{ steps.config.outputs.repository }}:arm64-${{ steps.config.outputs.version }}
          cache-from: type=gha,scope=arm64
          cache-to: type=gha,mode=max,scope=arm64

  merge:
    needs: [build-amd64, build-arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create multi-arch manifest
        shell: bash
        env:
          REPO: ${{ needs.build-amd64.outputs.repository }}
          VERSION: ${{ needs.build-amd64.outputs.version }}
          AMD64_DIGEST: ${{ needs.build-amd64.outputs.digest }}
          ARM64_DIGEST: ${{ needs.build-arm64.outputs.digest }}
        run: |
          set -euo pipefail

          echo "Creating manifest for ${REPO}:${VERSION}"

          # Create version tag
          docker buildx imagetools create \
            --tag "${REPO}:${VERSION}" \
            "${REPO}@${AMD64_DIGEST}" \
            "${REPO}@${ARM64_DIGEST}"

          # Create latest tag if this is a semantic version
          if [[ "${VERSION}" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Creating ${REPO}:latest"
            docker buildx imagetools create \
              --tag "${REPO}:latest" \
              "${REPO}@${AMD64_DIGEST}" \
              "${REPO}@${ARM64_DIGEST}"
          fi
